<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🛠️ React Fusion State - DevTools Demo</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div class="container">
        <div id="root"></div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback, memo, createContext, useContext } = React;

        // Simplified React Fusion State Implementation for Demo
        const FusionStateContext = createContext(null);

        const useFusionState = (key, initialValue) => {
            const context = useContext(FusionStateContext);
            if (!context) {
                throw new Error('useFusionState must be used within a FusionStateProvider');
            }
            
            const { state, setState } = context;
            const value = state[key] !== undefined ? state[key] : initialValue;
            
            const setValue = useCallback((newValue) => {
                setState(prevState => ({
                    ...prevState,
                    [key]: typeof newValue === 'function' ? newValue(value) : newValue
                }));
            }, [key, value, setState]);
            
            return [value, setValue];
        };

        const useFusionStateLog = () => {
            const context = useContext(FusionStateContext);
            if (!context) return {};
            return context.state;
        };

        const createLocalStorageAdapter = (debug = false) => {
            if (typeof localStorage === 'undefined') {
                if (debug) {
                    console.warn('localStorage is not available, falling back to noop adapter');
                }
                return {
                    async getItem() { return null; },
                    getItemSync() { return null; },
                    async setItem() {},
                    async removeItem() {},
                };
            }

            return {
                async getItem(key) {
                    try {
                        return localStorage.getItem(key);
                    } catch (error) {
                        if (debug) {
                            console.error('Error reading from localStorage:', error);
                        }
                        return null;
                    }
                },

                getItemSync(key) {
                    try {
                        return localStorage.getItem(key);
                    } catch (error) {
                        if (debug) {
                            console.error('Error reading from localStorage:', error);
                        }
                        return null;
                    }
                },

                async setItem(key, value) {
                    try {
                        localStorage.setItem(key, value);
                    } catch (error) {
                        if (debug) {
                            console.error('Error writing to localStorage:', error);
                        }
                    }
                },

                async removeItem(key) {
                    try {
                        localStorage.removeItem(key);
                    } catch (error) {
                        if (debug) {
                            console.error('Error removing from localStorage:', error);
                        }
                    }
                },
            };
        };

        const FusionStateProvider = ({ children, persistence = false, debug = false }) => {
            const adapter = useMemo(() => createLocalStorageAdapter(debug), [debug]);
            const keyPrefix = 'devtools_demo';
            
            // Synchronous loading at startup
            const [state, setState] = useState(() => {
                if (persistence && adapter.getItemSync) {
                    try {
                        const stored = adapter.getItemSync(`${keyPrefix}_all`);
                        if (stored) {
                            const data = JSON.parse(stored);
                            if (debug) {
                                console.log('✅ State loaded from localStorage:', data);
                            }
                            return data;
                        }
                    } catch (error) {
                        if (debug) {
                            console.warn('⚠️ Loading error:', error);
                        }
                    }
                }
                return {};
            });

            const [isLoaded, setIsLoaded] = useState(true);

            // Save when state changes
            useEffect(() => {
                if (persistence && adapter && isLoaded && Object.keys(state).length > 0) {
                    const saveData = async () => {
                        try {
                            const dataToSave = JSON.stringify(state);
                            await adapter.setItem(`${keyPrefix}_all`, dataToSave);
                            if (debug) {
                                console.log('💾 State saved:', state);
                            }
                        } catch (error) {
                            if (debug) {
                                console.error('❌ Save error:', error);
                            }
                        }
                    };
                    saveData();
                }
            }, [state, persistence, adapter, isLoaded, debug]);

            const updateState = useCallback((updater) => {
                setState(prevState => {
                    const nextState = typeof updater === 'function' ? updater(prevState) : updater;
                    
                    if (debug) {
                        console.log('[FusionState] State updated:', {
                            previous: prevState,
                            next: nextState,
                            diff: Object.fromEntries(
                                Object.entries(nextState).filter(
                                    ([key, value]) => prevState[key] !== value,
                                ),
                            ),
                        });
                    }
                    
                    return nextState;
                });
            }, [debug]);

            const value = useMemo(() => ({
                state,
                setState: updateState,
            }), [state, updateState]);

            return React.createElement(FusionStateContext.Provider, { value }, children);
        };

        // FusionDebugPanel - Enhanced version
        const FusionDebugPanel = ({ visible, onVisibilityChange }) => {
            const globalSnapshot = useFusionStateLog();
            const context = useContext(FusionStateContext);
            if (!context) {
                console.error('FusionDebugPanel must be used within a FusionStateProvider');
                return null;
            }
            const { setState } = context;
            const [expandedKeys, setExpandedKeys] = useState({});
            const [editValues, setEditValues] = useState({});
            const [errors, setErrors] = useState({});
            
            console.log('FusionDebugPanel render:', { visible, globalSnapshot });
            
            // Keyboard shortcut
            useEffect(() => {
                const handleKeyDown = (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.key === '`') {
                        e.preventDefault();
                        onVisibilityChange?.(!visible);
                    }
                };
                
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [visible, onVisibilityChange]);

            // Initialize edit values when state changes
            useEffect(() => {
                const newEditValues = {};
                Object.keys(globalSnapshot).forEach(key => {
                    if (!(key in editValues)) {
                        newEditValues[key] = JSON.stringify(globalSnapshot[key], null, 2);
                    }
                });
                if (Object.keys(newEditValues).length > 0) {
                    setEditValues(prev => ({ ...prev, ...newEditValues }));
                }
            }, [globalSnapshot]);
            
            if (!visible) {
                console.log('FusionDebugPanel not visible, returning null');
                return null;
            }
            
            console.log('FusionDebugPanel rendering panel UI');

            const toggleExpanded = (key) => {
                setExpandedKeys(prev => ({ ...prev, [key]: !prev[key] }));
            };

            const updateEditValue = (key, value) => {
                setEditValues(prev => ({ ...prev, [key]: value }));
                
                // Validate JSON
                try {
                    JSON.parse(value);
                    setErrors(prev => ({ ...prev, [key]: false }));
                } catch (e) {
                    setErrors(prev => ({ ...prev, [key]: true }));
                }
            };

            const applyValue = (key) => {
                if (errors[key]) return;
                
                try {
                    const parsed = JSON.parse(editValues[key]);
                    setState(prev => ({ ...prev, [key]: parsed }));
                } catch (e) {
                    alert('Invalid JSON format');
                }
            };

            const resetValue = (key) => {
                setState(prev => ({ ...prev, [key]: null }));
                setEditValues(prev => ({ ...prev, [key]: 'null' }));
            };

            const exportSnapshot = () => {
                const dataStr = JSON.stringify(globalSnapshot, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `fusion-state-snapshot-${Date.now()}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            };

            const importSnapshot = () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const imported = JSON.parse(e.target.result);
                            setState(prev => ({ ...prev, ...imported }));
                        } catch (error) {
                            alert('Invalid JSON file');
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            };
            
            return React.createElement('div', {
                style: {
                    position: 'fixed',
                    bottom: '20px',
                    right: '20px',
                    width: '400px',
                    maxHeight: '600px',
                    backgroundColor: '#1a1a1a',
                    color: 'white',
                    border: '1px solid #333',
                    borderRadius: '8px',
                    fontFamily: 'Monaco, Consolas, "Courier New", monospace',
                    fontSize: '12px',
                    zIndex: 9999,
                    overflow: 'hidden',
                    boxShadow: '0 8px 32px rgba(0, 0, 0, 0.3)'
                }
            }, [
                // Header
                React.createElement('div', {
                    key: 'header',
                    style: {
                        backgroundColor: '#2d2d2d',
                        padding: '12px 16px',
                        borderBottom: '1px solid #333',
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center'
                    }
                }, [
                    React.createElement('h3', { 
                        key: 'title', 
                        style: { margin: 0, fontSize: '14px', fontWeight: 'bold' } 
                    }, 'Fusion State Debugger'),
                    React.createElement('div', { key: 'buttons' }, [
                        React.createElement('button', {
                            key: 'export',
                            onClick: exportSnapshot,
                            style: { 
                                marginLeft: '8px', 
                                padding: '4px 8px', 
                                fontSize: '11px',
                                backgroundColor: '#404040',
                                border: 'none',
                                color: 'white',
                                borderRadius: '4px',
                                cursor: 'pointer'
                            }
                        }, 'Export'),
                        React.createElement('button', {
                            key: 'import',
                            onClick: importSnapshot,
                            style: { 
                                marginLeft: '8px', 
                                padding: '4px 8px', 
                                fontSize: '11px',
                                backgroundColor: '#404040',
                                border: 'none',
                                color: 'white',
                                borderRadius: '4px',
                                cursor: 'pointer'
                            }
                        }, 'Import'),
                        React.createElement('button', {
                            key: 'close',
                            onClick: () => onVisibilityChange?.(false),
                            style: { 
                                marginLeft: '8px', 
                                padding: '4px 8px', 
                                fontSize: '11px',
                                backgroundColor: '#404040',
                                border: 'none',
                                color: 'white',
                                borderRadius: '4px',
                                cursor: 'pointer'
                            }
                        }, '×')
                    ])
                ]),
                
                // Content
                React.createElement('div', {
                    key: 'content',
                    style: { 
                        padding: '16px', 
                        maxHeight: '500px', 
                        overflowY: 'auto' 
                    }
                }, Object.keys(globalSnapshot).length === 0 ? 
                    React.createElement('div', {
                        style: { color: '#888', textAlign: 'center', padding: '20px' }
                    }, 'No state keys found') :
                    Object.keys(globalSnapshot).sort().map(key => 
                        React.createElement('div', {
                            key,
                            style: { 
                                marginBottom: '12px', 
                                border: '1px solid #333', 
                                borderRadius: '4px',
                                backgroundColor: '#222'
                            }
                        }, [
                            // State header
                            React.createElement('div', {
                                key: 'header',
                                onClick: () => toggleExpanded(key),
                                style: {
                                    padding: '8px 12px',
                                    backgroundColor: '#2a2a2a',
                                    borderBottom: expandedKeys[key] ? '1px solid #333' : 'none',
                                    cursor: 'pointer',
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                    alignItems: 'center'
                                }
                            }, [
                                React.createElement('span', {
                                    key: 'key',
                                    style: { fontWeight: 'bold', color: '#4fc3f7' }
                                }, `${expandedKeys[key] ? '▼' : '▶'} ${key}`),
                                React.createElement('span', {
                                    key: 'type',
                                    style: { color: '#888', fontSize: '10px' }
                                }, `${typeof globalSnapshot[key]}${globalSnapshot[key] === null ? ' (null)' : ''}`)
                            ]),
                            
                            // Expanded content
                            expandedKeys[key] && React.createElement('div', {
                                key: 'content',
                                style: { padding: '12px' }
                            }, [
                                React.createElement('textarea', {
                                    key: 'textarea',
                                    value: editValues[key] || '',
                                    onChange: (e) => updateEditValue(key, e.target.value),
                                    style: {
                                        width: '100%',
                                        minHeight: '80px',
                                        backgroundColor: '#1a1a1a',
                                        color: 'white',
                                        border: errors[key] ? '1px solid #f44336' : '1px solid #333',
                                        borderRadius: '4px',
                                        padding: '8px',
                                        fontFamily: 'inherit',
                                        fontSize: '11px',
                                        resize: 'vertical',
                                        outline: 'none'
                                    },
                                    placeholder: 'Enter valid JSON...'
                                }),
                                React.createElement('div', {
                                    key: 'buttons',
                                    style: { display: 'flex', gap: '8px', marginTop: '8px' }
                                }, [
                                    React.createElement('button', {
                                        key: 'set',
                                        onClick: () => applyValue(key),
                                        disabled: errors[key],
                                        style: {
                                            padding: '4px 8px',
                                            fontSize: '11px',
                                            backgroundColor: errors[key] ? '#666' : '#4caf50',
                                            border: 'none',
                                            color: 'white',
                                            borderRadius: '4px',
                                            cursor: errors[key] ? 'not-allowed' : 'pointer',
                                            marginLeft: '8px'
                                        }
                                    }, 'Set'),
                                    React.createElement('button', {
                                        key: 'reset',
                                        onClick: () => resetValue(key),
                                        style: {
                                            padding: '4px 8px',
                                            fontSize: '11px',
                                            backgroundColor: '#f44336',
                                            border: 'none',
                                            color: 'white',
                                            borderRadius: '4px',
                                            cursor: 'pointer',
                                            marginLeft: '8px'
                                        }
                                    }, 'Reset')
                                ]),
                                errors[key] && React.createElement('div', {
                                    key: 'error',
                                    style: { 
                                        color: '#f44336', 
                                        fontSize: '10px', 
                                        marginTop: '4px' 
                                    }
                                }, 'Invalid JSON format')
                            ])
                        ])
                    )
                )
            ]);
        };

        // Demo Components using the beautiful existing CSS classes
        const Counter = () => {
            const [count, setCount] = useFusionState('counter', 0);

            return (
                <div className="demo-box">
                    <h3>
                        <span className="emoji">🔢</span>
                        Smart Counter
                    </h3>
                    <div className="value">{count}</div>
                    <div className="button-group">
                        <button className="button primary" onClick={() => setCount(count + 1)}>
                            ➕ Increment
                        </button>
                        <button className="button secondary" onClick={() => setCount(count - 1)}>
                            ➖ Decrement
                        </button>
                        <button className="button danger" onClick={() => setCount(0)}>
                            🔄 Reset
                        </button>
                    </div>
                </div>
            );
        };

        const UserProfile = () => {
            const [user, setUser] = useFusionState('user', {
                name: 'John Doe',
                age: 30,
                email: 'john@example.com'
            });

            return (
                <div className="demo-box">
                    <h3>
                        <span className="emoji">👤</span>
                        User Profile
                    </h3>
                    <div className="input-group">
                        <label htmlFor="name-input">Name:</label>
                        <input
                            id="name-input"
                            type="text"
                            value={user.name}
                            onChange={(e) => setUser(prev => ({ ...prev, name: e.target.value }))}
                        />
                    </div>
                    <div className="input-group">
                        <label htmlFor="age-input">Age:</label>
                        <input
                            id="age-input"
                            type="number"
                            value={user.age}
                            onChange={(e) => setUser(prev => ({ ...prev, age: parseInt(e.target.value) || 0 }))}
                            min="0"
                            max="150"
                        />
                    </div>
                    <div className="button-group">
                        <button 
                            className="button primary" 
                            onClick={() => setUser(prev => ({ ...prev, age: prev.age + 1 }))}
                        >
                            🎂 Birthday!
                        </button>
                    </div>
                </div>
            );
        };

        const DevToolsInfo = () => {
            return (
                <div className="status-box">
                    <h3>🛠️ DevTools Demo</h3>
                    <p><strong>How to use:</strong></p>
                    <ul>
                        <li>Press <strong>Ctrl+`</strong> (or <strong>Cmd+`</strong> on macOS) to toggle the debug panel</li>
                        <li><strong>Drag Panel:</strong> Click and drag the debug panel header to move it anywhere on screen</li>
                        <li>Click ▶ to expand state keys and edit as JSON</li>
                        <li>Use "Set" to apply changes or "Reset" to set to null</li>
                        <li>Export/Import complete state snapshots</li>
                    </ul>
                    <p><strong>The debug panel will appear in the bottom-right corner when visible.</strong></p>
                </div>
            );
        };

        // Main Application
        const App = () => {
            const [debugVisible, setDebugVisible] = useState(false);
            const [debugMode, setDebugMode] = useState(false);
            
            return (
                <>
                    <h1>🛠️ React Fusion State</h1>
                    <div className="subtitle">DevTools Demo - Interactive State Debugging</div>
                    
                    <DevToolsInfo />

                    <div className="debug-control">
                        <h2>🎛️ Debug Controls</h2>
                        <label>
                            <input 
                                type="checkbox" 
                                checked={debugMode}
                                onChange={(e) => setDebugMode(e.target.checked)}
                            />
                            <strong>Debug Console {debugMode ? '(Logs enabled 📝)' : '(Silent 🤫)'}</strong>
                        </label>
                        <div className="description">
                            Toggle debug mode to see console logs for state changes and persistence.
                        </div>
                    </div>

                    <div className="debug-control">
                        <h2>🔧 DevTools Panel</h2>
                        <button 
                            className="button primary"
                            onClick={() => setDebugVisible(!debugVisible)}
                        >
                            {debugVisible ? '🔧 Hide DevTools' : '🛠️ Show DevTools'}
                        </button>
                        <div className="description">
                            Or press <strong>Ctrl+`</strong> (Cmd+` on macOS) to toggle the debug panel.
                        </div>
                    </div>
                    
                    <FusionStateProvider 
                        persistence={true}
                        debug={debugMode}
                    >
                        <Counter />
                        <UserProfile />
                        
                        <FusionDebugPanel 
                            visible={debugVisible}
                            onVisibilityChange={setDebugVisible}
                        />
                    </FusionStateProvider>
                </>
            );
        };

        // Render
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        // Initial logs (only shown once)
        console.log('🛠️ React Fusion State DevTools Demo started');
        console.log('💡 Press Ctrl+` (or Cmd+` on macOS) to toggle the debug panel');
        console.log('🔇 Toggle "Debug Console" to enable/disable state change logs');
    </script>
</body>
</html>